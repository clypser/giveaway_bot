#!/bin/bash
# ----------------------------------------------------------------------
# Скрипт обновления (ВЕРСИЯ ДЛЯ VENV)
# ----------------------------------------------------------------------

WORK_DIR="/home/user/telegram_bot"  # <-- ПРОВЕРЬ ЭТОТ ПУТЬ! (если /root/, исправь)
cd $WORK_DIR

echo "--- Начинаем обновление ---"

# 1. Скачиваем код
git pull

# 2. Активируем окружение и обновляем библиотеки
# Используем полный путь к pip внутри venv
./venv/bin/pip install -r requirements.txt

# 3. Останавливаем старого бота
PID=$(ps aux | grep 'python main.py' | grep -v grep | awk '{print $2}')
if [ ! -z "$PID" ]; then
  kill -9 $PID
  echo "Старый бот остановлен."
fi

# 4. Запускаем бота, ИСПОЛЬЗУЯ PYTHON ИЗ VENV
# Мы указываем прямой путь к python внутри папки venv
nohup ./venv/bin/python main.py > nohup.out 2>&1 &

echo "--- Бот успешно обновлен и перезапущен! ---"